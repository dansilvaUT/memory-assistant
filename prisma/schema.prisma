// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

// User model
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String?  // Optional for now (mock auth)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sessions  MemorySession[]
  memories  Memory[]

  @@map("users")
}

// Memory Session model
model MemorySession {
  id                 String    @id @default(cuid())
  userId             String
  title              String?
  description        String?
  category           String?   // childhood, family, etc.
  currentQuestionId  String?
  status             String    @default("in_progress") // in_progress, completed, archived
  startedAt          DateTime  @default(now())
  completedAt        DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // Relations
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  memories           Memory[]
  answeredQuestions  AnsweredQuestion[]

  @@map("memory_sessions")
  @@index([userId])
  @@index([status])
}

// Memory model
model Memory {
  id              String    @id @default(cuid())
  userId          String
  sessionId       String?
  questionId      String    // Reference to question in questions.ts
  questionPrompt  String    // Store the actual prompt text
  answerText      String    @db.Text
  enhancedText    String?   @db.Text // AI-enhanced version
  dateOfMemory    DateTime? // When the memory occurred (not when it was recorded)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  session         MemorySession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  mediaItems      MediaItem[]

  @@map("memories")
  @@index([userId])
  @@index([sessionId])
  @@index([dateOfMemory])
}

// Media Item model (photos, audio, video)
model MediaItem {
  id          String   @id @default(cuid())
  memoryId    String
  type        String   // photo, audio, video
  url         String
  fileName    String
  fileSize    Int?
  mimeType    String?
  caption     String?
  uploadedAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  memory      Memory   @relation(fields: [memoryId], references: [id], onDelete: Cascade)

  @@map("media_items")
  @@index([memoryId])
  @@index([type])
}

// Track which questions have been answered in a session
model AnsweredQuestion {
  id         String        @id @default(cuid())
  sessionId  String
  questionId String
  answeredAt DateTime      @default(now())

  // Relations
  session    MemorySession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, questionId])
  @@map("answered_questions")
  @@index([sessionId])
}
